server {
    listen 80;

    # --- Règles de Proxy pour waspleditor (Frontend/Backend) ---

    # Règle Spécifique pour les appels API /users/ qui sortent du frontend comme /editor/users/
    # Le frontend appelle `/editor/users/:id`, mais le backend écoute `/api/users/:id`.
    # Cette règle mappe `/editor/users/...` à `/api/users/...` sur le backend.
    location /editor/users/ {
        # Exemple : /editor/users/123 -> proxy_pass vers http://waspleditor:4000/api/users/123
        # Nginx retire /editor/users/, ajoute /api/users/ au proxy_pass target
        proxy_pass http://waspleditor:4000/api/users/; # <-- Cible modifiée pour inclure /api/users/
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10M;
    }

    # Règle Générale pour les appels API qui sortent du frontend comme /editor/api/...
    # Ceci inclut la route de login (/editor/api/auth/login).
    # Cette règle mappe /editor/api/... à /api/... sur le backend.
    location /editor/api/ {
        # Exemple : /editor/api/auth/login -> proxy_pass vers http://waspleditor:4000/api/auth/login
        # Nginx retire /editor/api/, ajoute /api/ au proxy_pass target
        proxy_pass http://waspleditor:4000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10M; # Correspond à express.json limit
    }

    # Règle pour les autres chemins sous /editor/ (assets statiques, fallback SPA pour le routing client)
    # Ces chemins ne sont ni /editor/users/... ni /editor/api/...
    location /editor/ {
        # Exemple : /editor/ -> proxy_pass vers http://waspleditor:4000/
        # Exemple : /editor/assets/xyz.js -> proxy_pass vers http://waspleditor:4000/assets/xyz.js
        # Nginx retire /editor/, ajoute le reste à la racine du proxy_pass target
        proxy_pass http://waspleditor:4000/; # <-- Cible à la racine du service editor
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Règles de Proxy pour waspltestrunner ---

    # Règle pour les appels API du testrunner (/testrunner/api/...)
    location /testrunner/api/ {
        # Exemple : /testrunner/api/run -> proxy_pass vers http://waspltestrunner:3011/api/run
        # Nginx retire /testrunner/api/, ajoute /api/ au proxy_pass target
        proxy_pass http://waspltestrunner:3011/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- Redirection et autres règles ---

    # Redirection de la racine / vers /editor/
    location / {
        return 302 /editor/;
    }

    # Vous pourriez ajouter des règles supplémentaires ici si nécessaire,
    # par exemple pour des fichiers favicon.ico, robots.txt à la racine.
}